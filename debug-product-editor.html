<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品编辑功能调试页面</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #ffffff;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .debug-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #f39c12;
        }
        .debug-btn {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s;
        }
        .debug-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(243, 156, 18, 0.4);
        }
        .debug-btn.success { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .debug-btn.danger { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .debug-btn.info { background: linear-gradient(135deg, #3498db, #2980b9); }
        .log-output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            border: 1px solid #333;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success { background: rgba(39, 174, 96, 0.2); border-left: 4px solid #27ae60; }
        .status.error { background: rgba(231, 76, 60, 0.2); border-left: 4px solid #e74c3c; }
        .status.info { background: rgba(52, 152, 219, 0.2); border-left: 4px solid #3498db; }
        .status.warning { background: rgba(243, 156, 18, 0.2); border-left: 4px solid #f39c12; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 产品编辑功能调试页面</h1>
        <p>用于测试和调试产品编辑功能的各个组件</p>
        
        <div class="debug-section">
            <h3>📋 模块加载状态检查</h3>
            <div id="module-status"></div>
            <button class="debug-btn info" onclick="checkModuleStatus()">检查模块状态</button>
            <button class="debug-btn" onclick="loadModules()">加载模块</button>
        </div>
        
        <div class="debug-section">
            <h3>🧪 功能测试</h3>
            <button class="debug-btn success" onclick="testCreateProduct()">测试创建产品</button>
            <button class="debug-btn" onclick="testEditProduct()">测试编辑产品</button>
            <button class="debug-btn info" onclick="testLanguageSwitch()">测试语言切换</button>
            <button class="debug-btn danger" onclick="testErrorHandling()">测试错误处理</button>
        </div>
        
        <div class="debug-section">
            <h3>📊 调试日志</h3>
            <button class="debug-btn" onclick="clearLog()">清空日志</button>
            <button class="debug-btn info" onclick="exportLog()">导出日志</button>
            <div id="log-output" class="log-output"></div>
        </div>
        
        <div class="debug-section">
            <h3>⚡ 快速修复</h3>
            <button class="debug-btn warning" onclick="reinitializeModules()">重新初始化模块</button>
            <button class="debug-btn" onclick="refreshPage()">刷新页面</button>
        </div>
    </div>

    <script>
        // 调试日志功能
        const logOutput = document.getElementById('log-output');
        let debugLogs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            debugLogs.push(logEntry);
            
            const logElement = document.createElement('div');
            logElement.textContent = logEntry;
            logElement.style.color = getLogColor(type);
            logOutput.appendChild(logElement);
            logOutput.scrollTop = logOutput.scrollHeight;
            
            console.log(logEntry);
        }

        function getLogColor(type) {
            switch(type) {
                case 'error': return '#ff6b6b';
                case 'warning': return '#feca57';
                case 'success': return '#48dbfb';
                case 'info': 
                default: return '#00ff00';
            }
        }

        function clearLog() {
            logOutput.innerHTML = '';
            debugLogs = [];
            log('日志已清空', 'info');
        }

        function exportLog() {
            const logText = debugLogs.join('\\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `product-editor-debug-${new Date().toISOString().slice(0,19)}.log`;
            a.click();
            URL.revokeObjectURL(url);
            log('日志已导出', 'success');
        }

        // 模块状态检查
        function checkModuleStatus() {
            log('开始检查模块状态...', 'info');
            
            const modules = {
                'initializeProductEditor': typeof window.initializeProductEditor,
                'openProductEditor': typeof window.openProductEditor,
                'closeProductEditor': typeof window.closeProductEditor,
                'initializeProductManagementModule': typeof window.initializeProductManagementModule,
                'addNewProduct': typeof window.addNewProduct,
                'viewProduct': typeof window.viewProduct,
                'switchLanguage': typeof window.switchLanguage
            };
            
            const statusDiv = document.getElementById('module-status');
            let statusHTML = '';
            let allReady = true;
            
            for (const [moduleName, status] of Object.entries(modules)) {
                const isReady = status === 'function';
                if (!isReady) allReady = false;
                
                statusHTML += `
                    <div class="status ${isReady ? 'success' : 'error'}">
                        <strong>${moduleName}</strong>: ${status}
                        ${isReady ? '✅' : '❌'}
                    </div>
                `;
                
                log(`${moduleName}: ${status}`, isReady ? 'success' : 'error');
            }
            
            statusDiv.innerHTML = statusHTML;
            
            if (allReady) {
                log('所有模块都已正确加载！', 'success');
            } else {
                log('部分模块未正确加载，需要检查', 'warning');
            }
        }

        // 加载模块
        async function loadModules() {
            log('开始加载模块...', 'info');
            
            try {
                // 模拟模块加载
                log('正在加载产品管理模块...', 'info');
                await loadScript('/modules/product-management.js');
                
                log('正在加载产品编辑器模块...', 'info');
                await loadScript('/modules/product-editor.js');
                
                // 等待模块初始化
                setTimeout(() => {
                    checkModuleStatus();
                    log('模块加载完成', 'success');
                }, 1000);
                
            } catch (error) {
                log(`模块加载失败: ${error.message}`, 'error');
            }
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // 测试功能
        function testCreateProduct() {
            log('测试创建产品功能...', 'info');
            
            if (typeof window.openProductEditor === 'function') {
                try {
                    window.openProductEditor(null, 'create');
                    log('创建产品测试成功！', 'success');
                } catch (error) {
                    log(`创建产品测试失败: ${error.message}`, 'error');
                }
            } else {
                log('openProductEditor 函数未找到', 'error');
                if (typeof window.addNewProduct === 'function') {
                    try {
                        window.addNewProduct();
                        log('使用 addNewProduct 替代测试成功', 'warning');
                    } catch (error) {
                        log(`addNewProduct 测试失败: ${error.message}`, 'error');
                    }
                } else {
                    log('addNewProduct 函数也未找到', 'error');
                }
            }
        }

        function testEditProduct() {
            log('测试编辑产品功能...', 'info');
            
            const mockProduct = {
                id: 1,
                name_zh: '测试产品',
                name_en: 'Test Product',
                price: 29.99,
                description_zh: '这是一个测试产品的描述',
                description_en: 'This is a test product description',
                featured: true
            };
            
            if (typeof window.openProductEditor === 'function') {
                try {
                    window.openProductEditor(mockProduct, 'edit');
                    log('编辑产品测试成功！', 'success');
                } catch (error) {
                    log(`编辑产品测试失败: ${error.message}`, 'error');
                }
            } else {
                log('openProductEditor 函数未找到', 'error');
                if (typeof window.viewProduct === 'function') {
                    try {
                        window.viewProduct(1);
                        log('使用 viewProduct 替代测试', 'warning');
                    } catch (error) {
                        log(`viewProduct 测试失败: ${error.message}`, 'error');
                    }
                } else {
                    log('viewProduct 函数也未找到', 'error');
                }
            }
        }

        function testLanguageSwitch() {
            log('测试语言切换功能...', 'info');
            
            if (typeof window.switchLanguage === 'function') {
                try {
                    window.switchLanguage('en');
                    log('切换到英文成功', 'success');
                    
                    setTimeout(() => {
                        window.switchLanguage('zh');
                        log('切换到中文成功', 'success');
                    }, 1000);
                } catch (error) {
                    log(`语言切换测试失败: ${error.message}`, 'error');
                }
            } else {
                log('switchLanguage 函数未找到', 'error');
            }
        }

        function testErrorHandling() {
            log('测试错误处理...', 'info');
            
            try {
                // 测试不存在的函数调用
                if (typeof nonExistentFunction === 'function') {
                    nonExistentFunction();
                } else {
                    log('错误处理测试：函数不存在检测正常', 'success');
                }
                
                // 测试空参数
                if (typeof window.openProductEditor === 'function') {
                    window.openProductEditor(undefined, 'invalid_mode');
                    log('错误处理测试：空参数处理正常', 'success');
                }
                
            } catch (error) {
                log(`错误处理测试捕获异常: ${error.message}`, 'warning');
            }
        }

        function reinitializeModules() {
            log('重新初始化模块...', 'info');
            
            const modules = [
                'initializeProductEditor',
                'initializeProductManagementModule'
            ];
            
            modules.forEach(moduleName => {
                if (typeof window[moduleName] === 'function') {
                    try {
                        window[moduleName]();
                        log(`${moduleName} 重新初始化成功`, 'success');
                    } catch (error) {
                        log(`${moduleName} 重新初始化失败: ${error.message}`, 'error');
                    }
                } else {
                    log(`${moduleName} 函数未找到`, 'warning');
                }
            });
            
            setTimeout(checkModuleStatus, 500);
        }

        function refreshPage() {
            log('刷新页面...', 'info');
            window.location.reload();
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            log('调试页面已加载', 'info');
            log('模拟localStorage adminToken', 'info');
            
            // 设置模拟的管理员token
            if (!localStorage.getItem('adminToken')) {
                localStorage.setItem('adminToken', 'debug-token-12345');
                log('已设置调试用的adminToken', 'info');
            }
            
            // 延迟检查模块状态
            setTimeout(() => {
                checkModuleStatus();
            }, 1000);
        });
    </script>
</body>
</html>
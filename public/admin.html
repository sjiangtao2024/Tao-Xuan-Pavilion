<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tao Ecommerce Admin</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; background-color: #f4f4f9; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h1, h2, h3 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
        h3 { border-bottom-width: 1px; margin-top: 20px; }
        .hidden { display: none; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input[type="text"], input[type="number"], input[type="password"], input[type="email"], textarea {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        textarea { min-height: 80px; resize: vertical; }
        button {
            background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px;
            cursor: pointer; font-size: 16px; transition: background-color 0.2s;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        #status-message {
            padding: 15px; margin-top: 20px; border-radius: 5px; text-align: center; font-weight: bold;
        }
        .status-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .product-list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;
        }
        .product-list-item:hover { background-color: #f0f8ff; }
        .lang-group { display: flex; gap: 15px; }
        .lang-group .form-group { flex: 1; }
        #current-media-list { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px; }
        .media-item {
            border: 1px solid #ddd; border-radius: 4px; padding: 10px; text-align: center; width: 150px;
        }
        .media-item img, .media-item video { max-width: 100%; height: 100px; object-fit: cover; border-radius: 4px; }
        .media-item p { font-size: 12px; margin: 5px 0 0; color: #666; }
        .media-item button { background-color: #dc3545; font-size: 12px; padding: 5px 10px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Tao Ecommerce Admin</h1>

        <!-- Login Section -->
        <div id="login-section" class="section">
            <h2>Login</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit">Login</button>
            </form>
        </div>

        <!-- Main Content - Hidden by default -->
        <div id="main-content" class="hidden">
            <div id="user-info"></div>
            <button id="logout-button" style="background-color: #dc3545; margin-bottom: 20px;">Logout</button>

            <!-- Create Product Section -->
            <div class="section">
                <h2>Create New Product</h2>
                <form id="create-product-form">
                    <div class="lang-group">
                        <div class="form-group">
                            <label for="create-name-en">Name (EN)</label>
                            <input type="text" id="create-name-en" required>
                        </div>
                        <div class="form-group">
                            <label for="create-name-zh">Name (ZH)</label>
                            <input type="text" id="create-name-zh">
                        </div>
                    </div>
                    <div class="lang-group">
                        <div class="form-group">
                            <label for="create-description-en">Description (EN)</label>
                            <textarea id="create-description-en" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="create-description-zh">Description (ZH)</label>
                            <textarea id="create-description-zh"></textarea>
                        </div>
                    </div>
                     <div class="lang-group">
                        <div class="form-group">
                            <label for="create-category-en">Category (EN)</label>
                            <input type="text" id="create-category-en" required>
                        </div>
                        <div class="form-group">
                            <label for="create-category-zh">Category (ZH)</label>
                            <input type="text" id="create-category-zh">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="create-price">Price (USD)</label>
                        <input type="number" id="create-price" step="0.01" required>
                        <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                            * 价格以美元为基准。前端将根据用户语言设置自动转换为相应货币显示。
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="create-media">Media (Images/Videos)</label>
                        <input type="file" id="create-media" multiple>
                    </div>
                    <button type="submit" id="create-product-button">Create Product</button>
                </form>
            </div>

            <!-- Product List Section -->
            <div class="section">
                <h2>Product List</h2>
                <div id="product-list">Loading products...</div>
            </div>

            <!-- Fetch and Edit Product Section -->
            <div class="section">
                <h2>Fetch & Edit Product</h2>
                <form id="fetch-product-form">
                    <div class="form-group">
                        <label for="product-id">Product ID:</label>
                        <input type="number" id="product-id" required>
                    </div>
                    <button type="submit">Fetch Product</button>
                </form>
                <div id="edit-product-form-container" class="hidden" style="margin-top: 20px;">
                    <form id="edit-product-form">
                        <h3>Editing Product #<span id="editing-product-id"></span></h3>
                        <div class="lang-group">
                            <div class="form-group">
                                <label for="edit-name-en">Name (EN)</label>
                                <input type="text" id="edit-name-en">
                            </div>
                            <div class="form-group">
                                <label for="edit-name-zh">Name (ZH)</label>
                                <input type="text" id="edit-name-zh">
                            </div>
                        </div>
                        <div class="lang-group">
                            <div class="form-group">
                                <label for="edit-description-en">Description (EN)</label>
                                <textarea id="edit-description-en"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="edit-description-zh">Description (ZH)</label>
                                <textarea id="edit-description-zh"></textarea>
                            </div>
                        </div>
                        <div class="lang-group">
                            <div class="form-group">
                                <label for="edit-category-en">Category (EN)</label>
                                <input type="text" id="edit-category-en">
                            </div>
                            <div class="form-group">
                                <label for="edit-category-zh">Category (ZH)</label>
                                <input type="text" id="edit-category-zh">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="edit-price">Price (USD)</label>
                            <input type="number" id="edit-price" step="0.01">
                            <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                                * 价格以美元为基准。前端将根据用户语言设置自动转换为相应货币显示。
                            </small>
                        </div>
                        <button type="submit" id="update-product-button">Update Product Info</button>
                    </form>

                    <div id="media-management-section">
                        <h3>Manage Media</h3>
                        <div id="current-media-list"></div>
                        <div class="form-group" style="margin-top: 15px;">
                            <label for="edit-media-upload">Upload New Media</label>
                            <input type="file" id="edit-media-upload" multiple>
                            <button type="button" id="upload-media-button" style="margin-top: 10px;">Upload Media</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="status-message"></div>
    </div>

    <script>
        const loginSection = document.getElementById('login-section');
        const mainContent = document.getElementById('main-content');
        const userInfo = document.getElementById('user-info');
        const statusMessage = document.getElementById('status-message');

        // --- API HELPER ---
        async function apiFetch(url, options = {}) {
            const token = localStorage.getItem('jwt_token');
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers,
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            if (options.body instanceof FormData) {
                delete headers['Content-Type'];
            }

            const response = await fetch(url, { ...options, headers });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'An unknown error occurred' }));
                console.error('API Fetch Error - Response not OK:', response);
                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
            }
            if (response.status === 204) return null;
            return response.json();
        }

        // --- UTILITY FUNCTIONS ---
        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = isError ? 'status-error' : 'status-success';
            statusMessage.classList.remove('hidden');
            setTimeout(() => statusMessage.classList.add('hidden'), 5000);
        }

        function toggleMainContent(isLoggedIn) {
            loginSection.classList.toggle('hidden', isLoggedIn);
            mainContent.classList.toggle('hidden', !isLoggedIn);
        }

        // --- PRODUCT LIST ---
        async function fetchAllProducts() {
            const productListDiv = document.getElementById('product-list');
            try {
                const products = await apiFetch('/api/products?lang=en');
                productListDiv.innerHTML = '';
                products.forEach(p => {
                    const item = document.createElement('div');
                    item.className = 'product-list-item';
                    item.innerHTML = `<span>ID: ${p.id}</span> <span>${p.name || '[No Name]'}</span> <span>Category: ${p.categoryName || 'N/A'}</span>`;
                    item.onclick = () => {
                        document.getElementById('product-id').value = p.id;
                        document.getElementById('fetch-product-form').requestSubmit();
                    };
                    productListDiv.appendChild(item);
                });
            } catch (error) {
                productListDiv.innerHTML = 'Failed to load products.';
                console.error('Failed to fetch products:', error);
            }
        }

        // --- AUTHENTICATION ---
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                const data = await apiFetch('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password }),
                });
                localStorage.setItem('jwt_token', data.token);
                await checkUserStatus();
            } catch (error) {
                showStatus(`Login failed: ${error.message}`, true);
            }
        }

        function handleLogout() {
            localStorage.removeItem('jwt_token');
            toggleMainContent(false);
            userInfo.textContent = '';
            document.getElementById('edit-product-form-container').classList.add('hidden');
        }

        async function checkUserStatus() {
            const token = localStorage.getItem('jwt_token');
            if (token) {
                try {
                    await apiFetch('/api/cart');
                    userInfo.textContent = 'Logged in successfully.';
                    toggleMainContent(true);
                    await fetchAllProducts();
                } catch (error) {
                    console.error("Token validation failed, logging out.", error);
                    handleLogout();
                }
            } else {
                toggleMainContent(false);
            }
        }

        // --- PRODUCT & MEDIA MANAGEMENT ---
        function renderMediaList(media, productId) {
            const container = document.getElementById('current-media-list');
            container.innerHTML = '';
            if (!media || media.length === 0) {
                container.innerHTML = '<p>No media associated with this product.</p>';
                return;
            }

            media.forEach(mediaLink => {
                const asset = mediaLink.asset;
                const itemDiv = document.createElement('div');
                itemDiv.className = 'media-item';
                if (mediaLink.displayOrder === 0) {
                    itemDiv.style.border = '2px solid gold';
                }

                if (asset.mediaType === 'image') {
                    itemDiv.innerHTML = `<img src="${asset.url}" alt="Product Media"><p>Type: Image</p>`;
                } else {
                    itemDiv.innerHTML = `<video controls src="${asset.url}"></video><p>Type: Video</p>`;
                }
                
                const buttonGroup = document.createElement('div');
                buttonGroup.style.marginTop = '10px';

                const setThumbnailBtn = document.createElement('button');
                setThumbnailBtn.textContent = 'Set as Thumbnail';
                setThumbnailBtn.style.backgroundColor = '#28a745';
                setThumbnailBtn.style.marginRight = '5px';
                setThumbnailBtn.onclick = () => handleSetThumbnail(mediaLink.id, productId);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => handleDeleteMedia(mediaLink.id, productId);

                buttonGroup.appendChild(setThumbnailBtn);
                buttonGroup.appendChild(deleteBtn);
                itemDiv.appendChild(buttonGroup);
                container.appendChild(itemDiv);
            });
        }

        async function handleSetThumbnail(mediaLinkId, productId) {
            try {
                showStatus('Setting thumbnail...');
                const updatedProduct = await apiFetch(`/api/products/${productId}/media/${mediaLinkId}/set-thumbnail`, { method: 'POST' });
                showStatus('Thumbnail set successfully!');
                renderMediaList(updatedProduct.media, productId);
            } catch (error) {
                showStatus(`Failed to set thumbnail: ${error.message}`, true);
            }
        }

        async function handleDeleteMedia(mediaLinkId, productId) {
            if (!confirm(`Are you sure you want to delete this media? This cannot be undone.`)) return;
            try {
                showStatus('Deleting media...');
                await apiFetch(`/api/media/${mediaLinkId}`, { method: 'DELETE' });
                showStatus('Media deleted successfully!');
                const product = await apiFetch(`/api/products/${productId}?lang=en`);
                renderMediaList(product.media, productId);
            } catch (error) {
                showStatus(`Failed to delete media: ${error.message}`, true);
            }
        }

        async function handleUploadMedia() {
            const productId = document.getElementById('editing-product-id').textContent;
            const files = document.getElementById('edit-media-upload').files;
            if (!files.length) {
                showStatus('Please select files to upload.', true);
                return;
            }

            const formData = new FormData();
            for (const file of files) {
                const fieldName = file.type.startsWith('image/') ? 'image' : 'video';
                formData.append(fieldName, file);
            }

            const button = document.getElementById('upload-media-button');
            button.disabled = true;
            button.textContent = 'Uploading...';

            try {
                showStatus(`Uploading ${files.length} file(s)...`);
                const updatedProduct = await apiFetch(`/api/products/${productId}/media`, {
                    method: 'POST',
                    body: formData,
                });
                showStatus('Media uploaded successfully!');
                renderMediaList(updatedProduct.media, productId);
                document.getElementById('edit-media-upload').value = '';
            } catch (error) {
                showStatus(`Upload failed: ${error.message}`, true);
            } finally {
                button.disabled = false;
                button.textContent = 'Upload Media';
            }
        }

        async function handleFetchProduct(event) {
            event.preventDefault();
            const productId = document.getElementById('product-id').value;
            if (!productId) return;

            try {
                showStatus('Fetching product...');
                const [productEn, productZh] = await Promise.all([
                    apiFetch(`/api/products/${productId}?lang=en`),
                    apiFetch(`/api/products/${productId}?lang=zh`)
                ]);

                document.getElementById('editing-product-id').textContent = productEn.id;
                document.getElementById('edit-name-en').value = productEn.name;
                document.getElementById('edit-description-en').value = productEn.description;
                document.getElementById('edit-category-en').value = productEn.categoryName;
                
                document.getElementById('edit-name-zh').value = productZh.name;
                document.getElementById('edit-description-zh').value = productZh.description;
                document.getElementById('edit-category-zh').value = productZh.categoryName;

                document.getElementById('edit-price').value = productEn.price;

                renderMediaList(productEn.media, productEn.id);

                document.getElementById('edit-product-form-container').classList.remove('hidden');
                showStatus(`Successfully fetched product ${productId}.`);
            } catch (error) {
                showStatus(`Failed to fetch product: ${error.message}`, true);
            }
        }

        async function handleUpdateProduct(event) {
            event.preventDefault();
            const productId = document.getElementById('editing-product-id').textContent;
            const button = document.getElementById('update-product-button');
            button.disabled = true;
            button.textContent = 'Updating...';

            try {
                // 更新英文版本
                await apiFetch(`/api/products/${productId}?lang=en`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        name: document.getElementById('edit-name-en').value,
                        description: document.getElementById('edit-description-en').value,
                        price: parseFloat(document.getElementById('edit-price').value),
                    }),
                });
                
                // 更新中文版本
                await apiFetch(`/api/products/${productId}?lang=zh`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        name: document.getElementById('edit-name-zh').value,
                        description: document.getElementById('edit-description-zh').value,
                    }),
                });

                showStatus('Product info updated successfully!');
                await fetchAllProducts();
            } catch (error) {
                showStatus(`Failed to update product info: ${error.message}`, true);
            } finally {
                button.disabled = false;
                button.textContent = 'Update Product Info';
            }
        }

        async function handleCreateProduct(event) {
            event.preventDefault();
            const button = document.getElementById('create-product-button');
            button.disabled = true;
            button.textContent = 'Creating...';

            try {
                showStatus('Step 1/2: Creating product...');
                const newProduct = await apiFetch('/api/products', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: document.getElementById('create-name-en').value,
                        description: document.getElementById('create-description-en').value,
                        price: parseFloat(document.getElementById('create-price').value),
                        featured: false,
                        lang: 'en'
                    }),
                });
                showStatus(`Step 1/2: Product ${newProduct.id} created.`);

                // 创建中文翻译
                if (document.getElementById('create-name-zh').value || document.getElementById('create-description-zh').value) {
                    await apiFetch(`/api/products/${newProduct.id}`, {
                        method: 'PATCH',
                        body: JSON.stringify({
                            name: document.getElementById('create-name-zh').value,
                            description: document.getElementById('create-description-zh').value,
                            lang: 'zh'
                        }),
                    });
                }

                const mediaFiles = document.getElementById('create-media').files;
                if (mediaFiles.length > 0) {
                    showStatus(`Step 2/2: Uploading ${mediaFiles.length} media file(s)...`);
                    const formData = new FormData();
                    for (const file of mediaFiles) {
                        const fieldName = file.type.startsWith('image/') ? 'image' : 'video';
                        formData.append(fieldName, file);
                    }
                    await apiFetch(`/api/products/${newProduct.id}/media`, {
                        method: 'POST',
                        body: formData,
                    });
                    showStatus('Step 2/2: Media uploaded successfully.');
                }
                
                showStatus('Product creation process complete!', false);
                document.getElementById('create-product-form').reset();
                await fetchAllProducts();

            } catch (error) {
                showStatus(`Failed to create product: ${error.message}`, true);
            } finally {
                button.disabled = false;
                button.textContent = 'Create Product';
            }
        }

        // 汇率计算功能已被移除，因为现在使用单一USD价格字段
        // 前端将根据用户语言设置自动调用汇率API进行转换

        // --- INITIALIZATION ---
        function initializeApp() {
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            document.getElementById('fetch-product-form').addEventListener('submit', handleFetchProduct);
            document.getElementById('edit-product-form').addEventListener('submit', handleUpdateProduct);
            document.getElementById('create-product-form').addEventListener('submit', handleCreateProduct);
            document.getElementById('upload-media-button').addEventListener('click', handleUploadMedia);
            checkUserStatus();
        }

        initializeApp();
    </script>
</body>
</html>

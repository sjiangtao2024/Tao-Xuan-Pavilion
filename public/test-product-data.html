<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品数据填充测试</title>
    <link rel="stylesheet" href="/css/admin.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #1a1a1a;
            border-radius: 10px;
        }
        
        .test-button {
            padding: 10px 20px;
            margin: 10px;
            background: #f39c12;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .test-button:hover {
            background: #e67e22;
        }
        
        .log-output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🧪 产品管理模块测试</h1>
        
        <div class="test-buttons">
            <button class="test-button" onclick="testLoadModules()">加载模块</button>
            <button class="test-button" onclick="testOpenEditor()">打开编辑器</button>
            <button class="test-button" onclick="testDataPopulation()">测试数据填充</button>
            <button class="test-button" onclick="testCategoryDropdown()">测试分类下拉框</button>
            <button class="test-button" onclick="clearLog()">清空日志</button>
        </div>
        
        <div class="log-output" id="log-output"></div>
    </div>

    <!-- 产品编辑器容器会动态插入到这里 -->
    
    <script>
        // 重写console.log以显示在页面上
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        function appendLog(message, type = 'log') {
            const logOutput = document.getElementById('log-output');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff0000' : type === 'warn' ? '#ffaa00' : '#00ff00';
            logOutput.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            appendLog(args.join(' '), 'log');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            appendLog(args.join(' '), 'warn');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            appendLog(args.join(' '), 'error');
        };
        
        // 测试函数
        async function testLoadModules() {
            console.log('=== 开始加载模块测试 ===');
            
            try {
                console.log('加载产品编辑器模块...');
                const editorModule = await import('/modules/product-editor.js');
                console.log('产品编辑器模块加载成功');
                
                console.log('加载产品表单模块...');
                const formModule = await import('/modules/product-form.js');
                console.log('产品表单模块加载成功');
                
                console.log('加载产品媒体模块...');
                const mediaModule = await import('/modules/product-media.js');
                console.log('产品媒体模块加载成功');
                
                console.log('初始化产品编辑器...');
                if (typeof window.initializeProductEditor === 'function') {
                    window.initializeProductEditor();
                    console.log('产品编辑器初始化完成');
                } else {
                    console.error('产品编辑器初始化函数不存在');
                }
                
            } catch (error) {
                console.error('模块加载失败:', error.message);
            }
        }
        
        function testOpenEditor() {
            console.log('=== 开始编辑器打开测试 ===');
            
            if (typeof window.openProductEditor === 'function') {
                const testData = {
                    id: 1,
                    name_zh: '测试产品中文名',
                    name_en: 'Test Product English Name',
                    description_zh: '这是一个测试产品的中文描述',
                    description_en: 'This is a test product English description',
                    price: 99.99,
                    categoryId: 'test-category',
                    featured: true
                };
                
                console.log('使用测试数据打开编辑器:', testData);
                window.openProductEditor(testData, 'edit');
            } else {
                console.error('openProductEditor函数不存在');
            }
        }
        
        function testDataPopulation() {
            console.log('=== 开始数据填充测试 ===');
            
            const testData = {
                id: 2,
                name_zh: '手工雕刻桃木剑',
                name_en: 'Hand-Carved Peach Wood Sword',
                description_zh: '取整块百年桃木，由资深道家匠人手工雕刻而成。桃木自古为辟邪之木，此剑悬挂于室，可斩断邪祟，净化磁场，亦可用于科仪法事，是镇宅护身的上佳之选。',
                description_en: 'A traditional Taoist ritual sword, hand-carved from century-old peach wood by experienced craftsmen.',
                price: 168.88,
                categoryId: 'spiritual-tools',
                featured: true
            };
            
            console.log('测试数据:', testData);
            
            if (typeof window.populateProductFormData === 'function') {
                console.log('直接调用数据填充函数...');
                window.populateProductFormData(testData);
            } else {
                console.error('populateProductFormData函数不存在');
            }
        }
        
        function testLanguageSwitchBug() {
            console.log('=== 测试语言切换Bug ===');
            
            // 首先加载模块
            testLoadModules();
            
            setTimeout(() => {
                // 打开编辑器
                const testData = {
                    id: 1,
                    name_zh: '中文产品名称',
                    name_en: 'English Product Name',
                    description_zh: '中文产品描述内容',
                    description_en: 'English product description content',
                    price: 99.99,
                    categoryId: 'test-category',
                    featured: true
                };
                
                console.log('打开编辑器并填充测试数据...');
                if (typeof window.openProductEditor === 'function') {
                    window.openProductEditor(testData, 'edit');
                    
                    // 等待编辑器加载完成
                    setTimeout(() => {
                        console.log('第一步：检查初始中文数据显示');
                        checkFormData('zh');
                        
                        setTimeout(() => {
                            console.log('第二步：切换到英文');
                            if (typeof window.switchLanguageTab === 'function') {
                                window.switchLanguageTab('en');
                                
                                setTimeout(() => {
                                    console.log('第三步：检查英文数据显示');
                                    checkFormData('en');
                                    
                                    setTimeout(() => {
                                        console.log('第四步：切换回中文');
                                        window.switchLanguageTab('zh');
                                        
                                        setTimeout(() => {
                                            console.log('第五步：检查中文数据是否保持');
                                            checkFormData('zh');
                                            console.log('语言切换Bug测试完成');
                                        }, 1000);
                                    }, 1000);
                                }, 1000);
                            }
                        }, 2000);
                    }, 3000);
                }
            }, 2000);
        }
        
        function checkDOMStructure() {
            console.log('=== 检查DOM结构 ===');
            
            // 检查语言标签
            const zhTab = document.querySelector('[onclick*="zh"]');
            const enTab = document.querySelector('[onclick*="en"]');
            
            console.log('中文标签:', zhTab ? `找到 - ${zhTab.textContent}` : '未找到');
            console.log('英文标签:', enTab ? `找到 - ${enTab.textContent}` : '未找到');
            
            // 检查语言内容区域
            const zhContent = document.getElementById('zh-form-content');
            const enContent = document.getElementById('en-form-content');
            
            console.log('中文内容区域:', zhContent ? `找到 - ID: ${zhContent.id}` : '未找到');
            console.log('英文内容区域:', enContent ? `找到 - ID: ${enContent.id}` : '未找到');
            
            if (zhContent) {
                const computedStyle = window.getComputedStyle(zhContent);
                console.log(`中文内容区域状态: display=${computedStyle.display}, active=${zhContent.classList.contains('active')}`);
            }
            
            if (enContent) {
                const computedStyle = window.getComputedStyle(enContent);
                console.log(`英文内容区域状态: display=${computedStyle.display}, active=${enContent.classList.contains('active')}`);
            }
            
            // 检查输入框
            const inputs = [
                'product-name-zh', 'product-name-en',
                'product-description-zh', 'product-description-en',
                'product-price', 'product-category', 'product-featured'
            ];
            
            console.log('输入框检查:');
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                console.log(`- ${inputId}: ${input ? '存在' : '不存在'}`);
            });
        }
        
        function testCategoryDropdown() {
            console.log('=== 测试分类下拉框样式 ===');
            
            // 首先加载模块并打开编辑器
            testLoadModules();
            
            setTimeout(() => {
                const testData = {
                    id: 1,
                    name_zh: '测试产品',
                    name_en: 'Test Product',
                    description_zh: '测试描述',
                    description_en: 'Test description',
                    price: 99.99,
                    categoryId: 'test',
                    featured: true
                };
                
                if (typeof window.openProductEditor === 'function') {
                    window.openProductEditor(testData, 'edit');
                    
                    setTimeout(() => {
                        console.log('检查分类下拉框元素:');
                        
                        const categorySelect = document.getElementById('product-category');
                        if (categorySelect) {
                            console.log('分类下拉框已找到');
                            
                            // 检查样式是否正确应用
                            const computedStyle = window.getComputedStyle(categorySelect);
                            console.log('下拉框样式:');
                            console.log(`- background: ${computedStyle.background}`);
                            console.log(`- color: ${computedStyle.color}`);
                            console.log(`- border: ${computedStyle.border}`);
                            
                            // 检查选项
                            const options = categorySelect.querySelectorAll('option');
                            console.log(`找到 ${options.length} 个选项`);
                            
                            if (options.length > 0) {
                                const firstOption = options[0];
                                const optionStyle = window.getComputedStyle(firstOption);
                                console.log('第一个选项样式:');
                                console.log(`- background: ${optionStyle.background}`);
                                console.log(`- color: ${optionStyle.color}`);
                            }
                            
                            console.log('请手动点击下拉框查看样式是否正常');
                        } else {
                            console.error('分类下拉框未找到');
                        }
                    }, 3000);
                }
            }, 2000);
        }
        
        function clearLog() {
            document.getElementById('log-output').innerHTML = '';
        }
        
        // 页面加载完成后自动测试
        window.addEventListener('load', () => {
            console.log('页面加载完成，开始自动测试...');
            setTimeout(testLoadModules, 1000);
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google OAuth æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #2563eb; }
        .status { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .status.success { background: #d1fae5; color: #065f46; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .status.info { background: #dbeafe; color: #1e3a8a; }
        #google-oauth-section {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            background: #f9f9f9;
        }
        #google-signin-container {
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Google OAuth åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>1. é…ç½®æ£€æŸ¥</h3>
        <div id="config-status"></div>
    </div>
    
    <div class="test-section">
        <h3>2. æ¨¡å—çŠ¶æ€</h3>
        <div id="module-status"></div>
        <button class="btn" onclick="checkModuleStatus()">åˆ·æ–°æ¨¡å—çŠ¶æ€</button>
    </div>
    
    <div class="test-section">
        <h3>3. Google OAuth æŒ‰é’®æµ‹è¯•</h3>
        <div id="google-oauth-section">
            <div id="google-signin-container">åŠ è½½ä¸­...</div>
        </div>
        <button class="btn" onclick="initializeOAuth()">é‡æ–°åˆå§‹åŒ– OAuth</button>
        <button class="btn" onclick="renderButton()">é‡æ–°æ¸²æŸ“æŒ‰é’®</button>
    </div>
    
    <div class="test-section">
        <h3>4. ç™»å½•æ¨¡æ€æ¡†æµ‹è¯•</h3>
        <button class="btn" onclick="testLoginModal()">æµ‹è¯•ç™»å½•æ¨¡æ€æ¡†</button>
        <div id="modal-test-status"></div>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center"></div>

    <!-- åŠ è½½å¿…è¦çš„è„šæœ¬ -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="i18n/zh.js"></script>
    <script src="i18n/en.js"></script>
    <script src="i18n/i18n.js"></script>
    <script src="components/modal.js"></script>
    <script src="components/message.js"></script>
    <script src="modules/google-oauth.js"></script>

    <script>
        let statusLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            statusLog.push(`[${timestamp}] ${message}`);
            console.log(`${type.toUpperCase()}: ${message}`);
        }

        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="status ${type}">${message}</div>`;
            }
        }

        function checkConfiguration() {
            log('æ£€æŸ¥é…ç½®...');
            
            if (window.APP_CONFIG) {
                const oauth = window.APP_CONFIG.GOOGLE_OAUTH;
                if (oauth && oauth.ENABLED) {
                    showStatus('config-status', 
                        `âœ… Google OAuth å·²å¯ç”¨<br>
                         Client ID: ${oauth.CLIENT_ID}<br>
                         Redirect URI: ${oauth.REDIRECT_URI}`, 
                        'success');
                    log('é…ç½®æ£€æŸ¥é€šè¿‡');
                } else {
                    showStatus('config-status', 'âŒ Google OAuth æœªå¯ç”¨', 'error');
                    log('Google OAuth æœªå¯ç”¨', 'error');
                }
            } else {
                showStatus('config-status', 'âŒ APP_CONFIG æœªæ‰¾åˆ°', 'error');
                log('APP_CONFIG æœªæ‰¾åˆ°', 'error');
            }
        }

        function checkModuleStatus() {
            log('æ£€æŸ¥æ¨¡å—çŠ¶æ€...');
            
            let status = '';
            
            if (window.GoogleOAuth) {
                status += `âœ… GoogleOAuth æ¨¡å—å·²åŠ è½½<br>`;
                status += `åˆå§‹åŒ–çŠ¶æ€: ${window.GoogleOAuth.isInitialized ? 'âœ… å·²åˆå§‹åŒ–' : 'âŒ æœªåˆå§‹åŒ–'}<br>`;
                status += `æ¼”ç¤ºæ¨¡å¼: ${window.GoogleOAuth.isDemoMode ? 'âœ… æ˜¯' : 'âŒ å¦'}<br>`;
                status += `é…ç½®: ${JSON.stringify(window.GoogleOAuth.config)}<br>`;
            } else {
                status += `âŒ GoogleOAuth æ¨¡å—æœªåŠ è½½<br>`;
            }
            
            if (window.ModalComponent) {
                status += `âœ… ModalComponent å·²åŠ è½½<br>`;
                status += `åˆå§‹åŒ–çŠ¶æ€: ${window.ModalComponent.isInitialized ? 'âœ… å·²åˆå§‹åŒ–' : 'âŒ æœªåˆå§‹åŒ–'}<br>`;
            } else {
                status += `âŒ ModalComponent æœªåŠ è½½<br>`;
            }
            
            showStatus('module-status', status, 'info');
            log('æ¨¡å—çŠ¶æ€æ£€æŸ¥å®Œæˆ');
        }

        function initializeOAuth() {
            log('æ‰‹åŠ¨åˆå§‹åŒ– Google OAuth...');
            
            if (window.GoogleOAuth) {
                // é‡ç½®çŠ¶æ€
                window.GoogleOAuth.isInitialized = false;
                window.GoogleOAuth.isDemoMode = false;
                
                // é‡æ–°åˆå§‹åŒ–
                window.GoogleOAuth.init();
                log('Google OAuth é‡æ–°åˆå§‹åŒ–å®Œæˆ');
                
                // å»¶è¿Ÿæ£€æŸ¥çŠ¶æ€
                setTimeout(() => {
                    checkModuleStatus();
                    renderButton();
                }, 1000);
            } else {
                log('GoogleOAuth æ¨¡å—æœªåŠ è½½', 'error');
            }
        }

        function renderButton() {
            log('æ¸²æŸ“ Google OAuth æŒ‰é’®...');
            
            const container = document.getElementById('google-signin-container');
            if (!container) {
                log('å®¹å™¨æœªæ‰¾åˆ°', 'error');
                return;
            }
            
            if (window.GoogleOAuth && window.GoogleOAuth.isInitialized) {
                container.innerHTML = 'æ­£åœ¨æ¸²æŸ“æŒ‰é’®...';
                
                setTimeout(() => {
                    window.GoogleOAuth.renderSignInButton('google-signin-container', {
                        theme: 'outline',
                        size: 'large',
                        text: 'signin_with',
                        width: '300'
                    });
                    log('Google OAuth æŒ‰é’®æ¸²æŸ“å®Œæˆ');
                }, 200);
            } else {
                container.innerHTML = 'âŒ Google OAuth æœªåˆå§‹åŒ–';
                log('Google OAuth æœªåˆå§‹åŒ–ï¼Œæ— æ³•æ¸²æŸ“æŒ‰é’®', 'error');
            }
        }

        function testLoginModal() {
            log('æµ‹è¯•ç™»å½•æ¨¡æ€æ¡†...');
            
            if (!window.ModalComponent) {
                showStatus('modal-test-status', 'âŒ ModalComponent æœªåŠ è½½', 'error');
                return;
            }
            
            try {
                // åˆå§‹åŒ–æ¨¡æ€æ¡†ç»„ä»¶ï¼ˆå¦‚æœæœªåˆå§‹åŒ–ï¼‰
                if (!window.ModalComponent.isInitialized) {
                    window.ModalComponent.init();
                }
                
                // åˆ›å»ºç™»å½•æ¨¡æ€æ¡†
                window.ModalComponent.createLoginModal();
                
                // æ‰“å¼€æ¨¡æ€æ¡†
                window.ModalComponent.open('login-modal');
                
                showStatus('modal-test-status', 'âœ… ç™»å½•æ¨¡æ€æ¡†å·²æ‰“å¼€ï¼Œè¯·æ£€æŸ¥ Google OAuth æŒ‰é’®', 'success');
                log('ç™»å½•æ¨¡æ€æ¡†æµ‹è¯•å®Œæˆ');
                
                // å»¶è¿Ÿæ£€æŸ¥ Google æŒ‰é’®
                setTimeout(() => {
                    const googleContainer = document.getElementById('google-signin-container');
                    if (googleContainer && googleContainer.innerHTML.trim()) {
                        log(`Google å®¹å™¨å†…å®¹: ${googleContainer.innerHTML}`);
                    } else {
                        log('Google å®¹å™¨ä¸ºç©ºæˆ–æœªæ‰¾åˆ°', 'error');
                    }
                }, 1000);
                
            } catch (error) {
                showStatus('modal-test-status', `âŒ æ¨¡æ€æ¡†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                log(`æ¨¡æ€æ¡†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            
            // ç­‰å¾…æ¨¡å—åŠ è½½
            setTimeout(() => {
                checkConfiguration();
                checkModuleStatus();
                
                // ç›‘å¬ OAuth åˆå§‹åŒ–äº‹ä»¶
                if (window.EventUtils) {
                    window.EventUtils.on('google-oauth-ready', () => {
                        log('æ”¶åˆ° google-oauth-ready äº‹ä»¶');
                        checkModuleStatus();
                        renderButton();
                    });
                }
                
                // å°è¯•æ¸²æŸ“æŒ‰é’®
                renderButton();
            }, 500);
        });

        // ç›‘å¬æ§åˆ¶å°è¾“å‡º
        const originalConsoleLog = console.log;
        console.log = function(...args) {
            if (args.length > 0 && typeof args[0] === 'string' && 
                (args[0].includes('oauth') || args[0].includes('OAuth') || args[0].includes('Google'))) {
                log(`Console: ${args.join(' ')}`);
            }
            originalConsoleLog.apply(console, args);
        };
        
        // æ·»åŠ å…¨å±€æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            .fixed { position: fixed; }
            .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
            .bg-black { background-color: black; }
            .bg-opacity-70 { background-color: rgba(0, 0, 0, 0.7); }
            .z-50 { z-index: 50; }
            .hidden { display: none; }
            .flex { display: flex; }
            .items-center { align-items: center; }
            .justify-center { justify-content: center; }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google OAuth 调试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .status-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-good { border-left: 4px solid #10b981; }
        .status-warning { border-left: 4px solid #f59e0b; }
        .status-error { border-left: 4px solid #ef4444; }
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #2563eb; }
        #debug-log {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>🔍 Google OAuth 调试工具</h1>
    
    <div class="status-card">
        <h3>系统状态检查</h3>
        <div id="system-status"></div>
    </div>
    
    <div class="status-card">
        <h3>操作控制</h3>
        <button class="btn" onclick="checkOAuthStatus()">检查 OAuth 状态</button>
        <button class="btn" onclick="reinitializeOAuth()">重新初始化 OAuth</button>
        <button class="btn" onclick="testLoginModal()">测试登录模态框</button>
        <button class="btn" onclick="clearLogs()">清空日志</button>
    </div>
    
    <div class="status-card">
        <h3>调试日志</h3>
        <div id="debug-log"></div>
    </div>

    <!-- 加载必要的脚本 -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="i18n/zh.js"></script>
    <script src="i18n/en.js"></script>
    <script src="i18n/i18n.js"></script>
    <script src="components/modal.js"></script>
    <script src="components/message.js"></script>
    <script src="modules/google-oauth.js"></script>

    <script>
        // 调试日志函数
        function debugLog(message) {
            const logElement = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // 检查系统状态
        function checkSystemStatus() {
            const statusElement = document.getElementById('system-status');
            let html = '';

            // 检查配置
            if (window.APP_CONFIG) {
                const oauthConfig = window.APP_CONFIG.GOOGLE_OAUTH;
                if (oauthConfig && oauthConfig.ENABLED) {
                    html += `<div class="status-good">✅ Google OAuth 已启用</div>`;
                    html += `<div>Client ID: ${oauthConfig.CLIENT_ID}</div>`;
                } else {
                    html += `<div class="status-error">❌ Google OAuth 未启用</div>`;
                }
            } else {
                html += `<div class="status-error">❌ APP_CONFIG 未找到</div>`;
            }

            // 检查模块
            if (window.GoogleOAuth) {
                html += `<div class="status-good">✅ GoogleOAuth 模块已加载</div>`;
                html += `<div>初始化状态: ${window.GoogleOAuth.isInitialized ? '已初始化' : '未初始化'}</div>`;
                html += `<div>演示模式: ${window.GoogleOAuth.isDemoMode ? '是' : '否'}</div>`;
            } else {
                html += `<div class="status-error">❌ GoogleOAuth 模块未加载</div>`;
            }

            // 检查模态框组件
            if (window.ModalComponent) {
                html += `<div class="status-good">✅ ModalComponent 已加载</div>`;
            } else {
                html += `<div class="status-error">❌ ModalComponent 未加载</div>`;
            }

            statusElement.innerHTML = html;
        }

        // 检查 OAuth 状态
        function checkOAuthStatus() {
            debugLog('=== OAuth 状态检查 ===');
            
            if (!window.GoogleOAuth) {
                debugLog('❌ GoogleOAuth 模块未加载');
                return;
            }

            debugLog(`初始化状态: ${window.GoogleOAuth.isInitialized}`);
            debugLog(`演示模式: ${window.GoogleOAuth.isDemoMode}`);
            debugLog(`配置: ${JSON.stringify(window.GoogleOAuth.config)}`);

            // 检查配置
            if (window.APP_CONFIG && window.APP_CONFIG.GOOGLE_OAUTH) {
                debugLog(`OAuth 启用: ${window.APP_CONFIG.GOOGLE_OAUTH.ENABLED}`);
                debugLog(`Client ID: ${window.APP_CONFIG.GOOGLE_OAUTH.CLIENT_ID}`);
            }

            // 检查登录模态框中的容器
            const googleContainer = document.getElementById('google-signin-container');
            if (googleContainer) {
                debugLog(`✅ Google 容器已找到，内容: ${googleContainer.innerHTML}`);
            } else {
                debugLog('❌ Google 容器未找到');
            }
        }

        // 重新初始化 OAuth
        function reinitializeOAuth() {
            debugLog('=== 重新初始化 OAuth ===');
            
            if (!window.GoogleOAuth) {
                debugLog('❌ GoogleOAuth 模块未加载');
                return;
            }

            // 重置状态
            window.GoogleOAuth.isInitialized = false;
            window.GoogleOAuth.isDemoMode = false;

            // 重新初始化
            window.GoogleOAuth.init();
            
            debugLog('✅ OAuth 重新初始化完成');
            
            // 延迟检查状态
            setTimeout(() => {
                checkOAuthStatus();
            }, 1000);
        }

        // 测试登录模态框
        function testLoginModal() {
            debugLog('=== 测试登录模态框 ===');
            
            if (!window.ModalComponent) {
                debugLog('❌ ModalComponent 未加载');
                return;
            }

            // 创建模态框元素（如果不存在）
            let loginModal = document.getElementById('login-modal');
            if (!loginModal) {
                loginModal = document.createElement('div');
                loginModal.id = 'login-modal';
                loginModal.className = 'fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center';
                document.body.appendChild(loginModal);
                debugLog('✅ 创建了登录模态框元素');
            }

            // 创建模态框内容
            window.ModalComponent.createLoginModal();
            debugLog('✅ 创建了模态框内容');

            // 打开模态框
            window.ModalComponent.open('login-modal');
            debugLog('✅ 打开了登录模态框');

            // 检查 Google 容器
            setTimeout(() => {
                const googleContainer = document.getElementById('google-signin-container');
                if (googleContainer) {
                    debugLog(`Google 容器内容: ${googleContainer.innerHTML}`);
                } else {
                    debugLog('❌ Google 容器未找到');
                }
            }, 500);
        }

        // 清空日志
        function clearLogs() {
            document.getElementById('debug-log').textContent = '';
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('🚀 调试页面加载完成');
            
            // 等待一段时间让所有模块初始化
            setTimeout(() => {
                checkSystemStatus();
                debugLog('📊 系统状态检查完成');
                
                // 监听 OAuth 准备事件
                if (window.EventUtils) {
                    window.EventUtils.on('google-oauth-ready', () => {
                        debugLog('🎉 收到 google-oauth-ready 事件');
                        checkSystemStatus();
                    });
                }
            }, 1000);
        });

        // 监听控制台日志
        const originalLog = console.log;
        console.log = function(...args) {
            if (args[0] && args[0].includes && args[0].includes('oauth')) {
                debugLog(`Console: ${args.join(' ')}`);
            }
            originalLog.apply(console, args);
        };
    </script>
</body>
</html>
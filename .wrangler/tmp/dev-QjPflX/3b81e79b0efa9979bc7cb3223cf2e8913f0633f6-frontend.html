<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tao Xuan Pavilion - Find Taoist Artifacts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-mystic-black: #1C1C1C;
            --bg-talisman-yellow: #EAE0C8;
            --text-on-dark: #EAE0C8;
            --text-on-light: #1C1C1C;
            --primary-cinnabar-red: #B83B1D;
            --primary-cinnabar-red-hover: #d14f31;
            --accent-gilded-gold: #A88F5A;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-mystic-black); color: var(--text-on-dark); }
        .font-serif-sc { font-family: 'Noto Serif SC', serif; }
        .product-card { transition: transform 0.3s ease, box-shadow 0.3s ease; background-color: var(--bg-talisman-yellow); color: var(--text-on-light); border: 1px solid var(--accent-gilded-gold); }
        .product-card:hover { transform: translateY(-8px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5); }
        .btn-primary { background-color: var(--primary-cinnabar-red); color: var(--text-on-dark); transition: background-color 0.3s ease; font-weight: bold; }
        .btn-primary:hover { background-color: var(--primary-cinnabar-red-hover); }
        .nav-link { position: relative; transition: color 0.3s ease; color: var(--text-on-dark); }
        .nav-link:hover { color: var(--accent-gilded-gold); }
        .nav-link::after { content: ''; position: absolute; width: 0; height: 2px; bottom: -4px; left: 50%; transform: translateX(-50%); background-color: var(--primary-cinnabar-red); transition: width 0.3s ease; }
        .nav-link:hover::after, .nav-link.active::after { width: 100%; }
        .lang-switcher button.active { color: var(--primary-cinnabar-red); font-weight: bold; }
        .text-primary { color: var(--primary-cinnabar-red); }
        .text-gold { color: var(--accent-gilded-gold); }
        .focus-ring-primary:focus { --tw-ring-color: var(--primary-cinnabar-red); border-color: var(--primary-cinnabar-red); }
        .carousel { position: relative; width: 100%; overflow: hidden; max-width: 600px; margin: 0 auto; }
        .carousel-inner { display: flex; transition: transform 0.5s ease; }
        .carousel-item { min-width: 100%; box-sizing: border-box; }
        .carousel-item img, .carousel-item video { width: 100%; display: block; border-radius: 0.5rem; }
        .carousel-control { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0, 0, 0, 0.5); color: white; border: none; padding: 0.5rem 1rem; cursor: pointer; border-radius: 50%; z-index: 10; font-size: 1.5rem; line-height: 1; }
        .carousel-control.prev { left: 1rem; }
        .carousel-control.next { right: 1rem; }
        /* 视频播放器优化样式 */
        .video-container { position: relative; width: 100%; background-color: #000; border-radius: 0.5rem; overflow: hidden; }
        .video-container video { width: 100%; height: auto; display: block; background-color: #000; position: relative; z-index: 1; }
        .video-container video::-webkit-media-controls { background-color: rgba(0, 0, 0, 0.8); }
        .video-container video::-webkit-media-controls-panel { background-color: rgba(0, 0, 0, 0.8); }
        /* 确保覆盖层不会阻挡视频 */
        .video-loading { z-index: 2; pointer-events: none; }
        .video-error { z-index: 3; pointer-events: auto; }
        .video-controls { z-index: 4; pointer-events: auto; }
    </style>
</head>
<body>

    <header class="bg-black bg-opacity-60 backdrop-blur-sm sticky top-0 z-50 shadow-lg shadow-black/30 border-b border-white/10">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-serif-sc font-bold tracking-wider text-gold" data-lang-key="siteName">Tao Xuan Pavilion</h1>
            <nav class="hidden md:flex items-center space-x-8">
                <a href="#home" class="nav-link text-lg active" onclick="showPage('home')" data-lang-key="navHome">Home</a>
                <a href="#shop" class="nav-link text-lg" onclick="showPage('shop')" data-lang-key="navShop">All Artifacts</a>
            </nav>
            <div class="flex items-center space-x-4">
                <div class="lang-switcher text-gray-300 text-sm">
                    <button id="lang-zh" class="hover:text-white transition">中文</button>
                    <span>/</span>
                    <button id="lang-en" class="hover:text-white transition">English</button>
                </div>
                <div id="auth-container">
                    <button id="login-button" class="btn-primary px-4 py-2 rounded-md text-sm" data-lang-key="login">Login</button>
                    <div id="user-profile" class="hidden items-center space-x-2">
                        <span id="user-email" class="text-sm text-gold"></span>
                        <button id="logout-button" class="text-gray-400 hover:text-white text-sm" data-lang-key="logout">Logout</button>
                    </div>
                </div>
                <button id="cart-button" class="relative">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-gray-300 hover:text-gold transition" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </button>
            </div>
        </div>
    </header>

    <main id="app-content">
        <div id="home-page" class="page"></div>
        <div id="shop-page" class="page hidden"></div>
        <div id="product-page" class="page hidden"></div>
    </main>

    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center"></div>
    <div id="register-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center"></div>
    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center"></div>
    <div id="message-modal" class="fixed top-20 right-5 text-white py-3 px-6 rounded-lg shadow-lg z-50 transform translate-x-[120%] transition-transform duration-500"><p id="message-text"></p></div>

    <script>
        // 全局变量
        const API_BASE_URL = window.location.origin;
        let user = null;
        let cart = { items: [] };
        let allProducts = [];
        let currentLang = 'en';
        let currentProductId = null;
        
        // 翻译数据
        const translations = {
            en: {
                siteName: 'Tao Xuan Pavilion',
                navHome: 'Home',
                navShop: 'All Artifacts',
                login: 'Login',
                logout: 'Logout',
                loginSuccess: 'Login successful!',
                loginFailed: 'Login failed. Please check your credentials.',
                registerSuccess: 'Registration successful! Please login.',
                registerFailed: 'Registration failed. Please try again.',
                email: 'Email',
                password: 'Password',
                confirmPassword: 'Confirm Password',
                passwordHint: 'Password must be at least 8 characters long',
                passwordMismatch: 'Passwords do not match',
                passwordTooShort: 'Password must be at least 8 characters long',
                invalidEmail: 'Please enter a valid email address',
                register: 'Register',
                addToCart: 'Add to Cart',
                viewDetails: 'View Details',
                cartEmpty: 'Your cart is empty',
                removeFromCart: 'Remove',
                quantity: 'Quantity',
                total: 'Total',
                checkout: 'Checkout',
                allCategories: 'All Categories',
                search: 'Search artifacts...',
                close: 'Close',
                currencySymbol: '$'
            },
            zh: {
                siteName: '道玄阁',
                navHome: '首页',
                navShop: '全部法器',
                login: '登录',
                logout: '退出',
                loginSuccess: '登录成功！',
                loginFailed: '登录失败，请检查您的凭据。',
                registerSuccess: '注册成功！请登录。',
                registerFailed: '注册失败，请重试。',
                email: '邮箱',
                password: '密码',
                confirmPassword: '确认密码',
                passwordHint: '密码必须至少8个字符',
                passwordMismatch: '密码不匹配',
                passwordTooShort: '密码必须至少8个字符',
                invalidEmail: '请输入有效的邮箱地址',
                register: '注册',
                addToCart: '加入购物车',
                viewDetails: '查看详情',
                cartEmpty: '您的购物车为空',
                removeFromCart: '移除',
                quantity: '数量',
                total: '总计',
                checkout: '结账',
                allCategories: '全部分类',
                search: '搜索法器...',
                close: '关闭',
                currencySymbol: '¥'
            }
        };

        // DOM 元素引用
        const loginModal = document.getElementById('login-modal');
        const registerModal = document.getElementById('register-modal');
        const cartModal = document.getElementById('cart-modal');
        const messageModal = document.getElementById('message-modal');
        const messageText = document.getElementById('message-text');
        const cartButton = document.getElementById('cart-button');
        const cartCount = document.getElementById('cart-count');
        const loginButton = document.getElementById('login-button');
        const userProfile = document.getElementById('user-profile');
        const userEmail = document.getElementById('user-email');
        const logoutButton = document.getElementById('logout-button');
        const langZh = document.getElementById('lang-zh');
        const langEn = document.getElementById('lang-en');

        // API 请求封装
        async function apiFetch(url, options = {}) {
            const token = localStorage.getItem('taoistShopToken');
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers,
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            let fullUrl = `${API_BASE_URL}${url}`;
            if (url.startsWith('/api/products/') && !url.includes('/media') && !url.includes('/categories')) {
                const productIdMatch = url.match(/\/api\/products\/(\d+)/);
                if (productIdMatch) {
                    const separator = url.includes('?') ? '&' : '?';
                    fullUrl = `${API_BASE_URL}${url}${separator}lang=${currentLang}`;
                }
            }
            
            const response = await fetch(fullUrl, { ...options, headers });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'An unknown error occurred' }));
                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
            }
            
            if (response.status === 204) {
                return null;
            }
            
            return response.json();
        }

        // 消息显示
        function showMessage(message, type = 'success') {
            messageText.textContent = message;
            messageModal.className = `fixed top-20 right-5 text-white py-3 px-6 rounded-lg shadow-lg z-50 transform transition-transform duration-500 ${
                type === 'error' ? 'bg-red-600' : 'bg-green-600'
            } translate-x-0`;
            
            if (messageModal.hideTimer) {
                clearTimeout(messageModal.hideTimer);
            }
            
            messageModal.hideTimer = setTimeout(() => {
                messageModal.className = messageModal.className.replace('translate-x-0', 'translate-x-[120%]');
                
                setTimeout(() => {
                    messageModal.className = 'fixed top-20 right-5 text-white py-3 px-6 rounded-lg shadow-lg z-50 transform translate-x-[120%] transition-transform duration-500';
                    messageText.textContent = '';
                }, 500);
            }, 3000);
        }

        // 模态框管理
        function openModal(modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal(modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // 语言切换
        function updateLanguage() {
            document.querySelectorAll('[data-lang-key]').forEach(element => {
                const key = element.getAttribute('data-lang-key');
                if (translations[currentLang][key]) {
                    element.textContent = translations[currentLang][key];
                }
            });
            
            langZh.classList.toggle('active', currentLang === 'zh');
            langEn.classList.toggle('active', currentLang === 'en');
        }

        // 用户认证相关
        async function login(email, password) {
            try {
                const data = await apiFetch('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password }),
                });
                
                localStorage.setItem('taoistShopToken', data.token);
                
                user = data.user || { email: email };
                updateAuthUI();
                
                const cartData = await apiFetch('/api/cart');
                cart = cartData || { items: [] };
                updateCart();
                
                closeModal(loginModal);
                showMessage(translations[currentLang].loginSuccess);
            } catch (error) {
                showMessage(translations[currentLang].loginFailed, 'error');
                console.error('登录失败:', error);
            }
        }

        async function register(email, password) {
            try {
                await apiFetch('/api/auth/register', {
                    method: 'POST',
                    body: JSON.stringify({ email, password }),
                });
                
                closeModal(registerModal);
                showMessage(translations[currentLang].registerSuccess);
            } catch (error) {
                showMessage(translations[currentLang].registerFailed, 'error');
                console.error('注册失败:', error);
            }
        }

        function logout() {
            localStorage.removeItem('taoistShopToken');
            user = null;
            cart = { items: [] };
            updateAuthUI();
            updateCart();
        }

        async function checkUserStatus() {
            const token = localStorage.getItem('taoistShopToken');
            if (token) {
                try {
                    const [userData, cartData] = await Promise.all([
                        apiFetch('/api/auth/me'),
                        apiFetch('/api/cart')
                    ]);
                    
                    user = userData;
                    cart = cartData || { items: [] };
                    
                    updateAuthUI();
                    updateCart();

                } catch (error) {
                    console.error('Token validation failed, logging out.', error);
                    logout();
                }
            } else {
                updateAuthUI();
                updateCart();
            }
        }

        function updateAuthUI() {
            if (user) {
                loginButton.classList.add('hidden');
                userProfile.classList.remove('hidden');
                userProfile.classList.add('flex');
                userEmail.textContent = user.email;
            } else {
                loginButton.classList.remove('hidden');
                userProfile.classList.add('hidden');
                userProfile.classList.remove('flex');
            }
        }

        // 购物车管理
        async function addToCart(productId, quantity = 1) {
            if (!user) {
                showMessage('Please login first', 'error');
                openModal(loginModal);
                return;
            }

            try {
                const updatedCart = await apiFetch('/api/cart/items', {
                    method: 'POST',
                    body: JSON.stringify({ productId, quantity }),
                });
                
                cart = updatedCart;
                updateCart();
                showMessage('Item added to cart successfully!');
            } catch (error) {
                showMessage('Failed to add item to cart', 'error');
                console.error('添加购物车失败:', error);
            }
        }

        async function updateCartQuantity(itemId, quantity) {
            try {
                await apiFetch(`/api/cart/items/${itemId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ quantity }),
                });
                
                const item = cart.items.find(item => item.id === itemId);
                if (item) {
                    item.quantity = quantity;
                }
                updateCart();
            } catch (error) {
                showMessage('Failed to update cart', 'error');
                console.error('更新购物车失败:', error);
            }
        }

        async function removeFromCart(itemId) {
            try {
                await apiFetch(`/api/cart/items/${itemId}`, {
                    method: 'DELETE',
                });
                
                cart.items = cart.items.filter(item => item.id !== itemId);
                updateCart();
                showMessage('Item removed from cart');
            } catch (error) {
                showMessage('Failed to remove item', 'error');
                console.error('移除购物车商品失败:', error);
            }
        }

        function updateCart() {
            const totalItems = cart.items.reduce((sum, item) => sum + item.quantity, 0);
            cartCount.textContent = totalItems;
            
            if (totalItems > 0) {
                cartCount.classList.remove('hidden');
            } else {
                cartCount.classList.add('hidden');
            }
        }

        // 模态框内容渲染
        function renderLoginModal() {
            loginModal.innerHTML = `
                <div class="bg-white rounded-lg max-w-md w-full mx-4" style="background-color: var(--bg-talisman-yellow); color: var(--text-on-light);">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-primary">${translations[currentLang].login}</h2>
                            <button onclick="closeModal(loginModal)" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <form id="login-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">${translations[currentLang].email}</label>
                                <input type="email" id="login-email" required class="w-full px-3 py-2 border border-gray-300 rounded-md" style="color: var(--text-on-light);">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">${translations[currentLang].password}</label>
                                <input type="password" id="login-password" required class="w-full px-3 py-2 border border-gray-300 rounded-md" style="color: var(--text-on-light);">
                            </div>
                            <button type="submit" class="w-full btn-primary py-2 rounded-md">${translations[currentLang].login}</button>
                            <p class="text-center text-sm">
                                Don't have an account? 
                                <button type="button" onclick="closeModal(loginModal); openModal(registerModal); renderRegisterModal();" class="text-primary hover:underline">
                                    ${translations[currentLang].register}
                                </button>
                            </p>
                        </form>
                    </div>
                </div>
            `;
            
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                await login(email, password);
            });
        }

        function renderRegisterModal() {
            registerModal.innerHTML = `
                <div class="bg-white rounded-lg max-w-md w-full mx-4" style="background-color: var(--bg-talisman-yellow); color: var(--text-on-light);">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-primary">${translations[currentLang].register}</h2>
                            <button onclick="closeModal(registerModal)" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <form id="register-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">${translations[currentLang].email}</label>
                                <input type="email" id="register-email" required class="w-full px-3 py-2 border border-gray-300 rounded-md" style="color: var(--text-on-light);">
                                <div id="email-error" class="text-red-600 text-xs mt-1 hidden"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">${translations[currentLang].password}</label>
                                <input type="password" id="register-password" required minlength="8" class="w-full px-3 py-2 border border-gray-300 rounded-md" style="color: var(--text-on-light);">
                                <div id="password-error" class="text-red-600 text-xs mt-1 hidden"></div>
                                <div class="text-gray-500 text-xs mt-1">${translations[currentLang].passwordHint}</div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">${translations[currentLang].confirmPassword}</label>
                                <input type="password" id="register-confirm-password" required minlength="8" class="w-full px-3 py-2 border border-gray-300 rounded-md" style="color: var(--text-on-light);">
                                <div id="confirm-password-error" class="text-red-600 text-xs mt-1 hidden"></div>
                            </div>
                            <div id="register-error" class="text-red-600 text-sm hidden"></div>
                            <button type="submit" class="w-full btn-primary py-2 rounded-md">${translations[currentLang].register}</button>
                            <p class="text-center text-sm">
                                Already have an account? 
                                <button type="button" onclick="closeModal(registerModal); openModal(loginModal); renderLoginModal();" class="text-primary hover:underline">
                                    ${translations[currentLang].login}
                                </button>
                            </p>
                        </form>
                    </div>
                </div>
            `;
            
            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                clearRegisterErrors();
                
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                
                if (validateRegisterForm(email, password, confirmPassword)) {
                    await register(email, password);
                }
            });
            
            document.getElementById('register-email').addEventListener('blur', () => {
                const email = document.getElementById('register-email').value;
                validateEmail(email);
            });
            
            document.getElementById('register-password').addEventListener('input', () => {
                const password = document.getElementById('register-password').value;
                validatePassword(password);
            });
            
            document.getElementById('register-confirm-password').addEventListener('input', () => {
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                validatePasswordConfirm(password, confirmPassword);
            });
        }

        function renderCartModal() {
            const cartContent = `
                <div class="bg-white rounded-lg max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col" style="background-color: var(--bg-talisman-yellow); color: var(--text-on-light);">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-primary">购物车</h2>
                            <button onclick="closeModal(cartModal)" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-6">
                        ${cart.items.length === 0 ? `
                            <div class="text-center py-8">
                                <p class="text-gray-500">${translations[currentLang].cartEmpty}</p>
                            </div>
                        ` : `
                            <div class="space-y-4">
                                ${cart.items.map(item => `
                                    <div class="flex items-center space-x-4 p-4 border border-gray-200 rounded-lg">
                                        <img src="${item.product?.imageUrl || '/placeholder.jpg'}" alt="${item.product?.name}" class="w-16 h-16 object-cover rounded">
                                        <div class="flex-1">
                                            <h3 class="font-semibold">${item.product?.name || 'Unknown Product'}</h3>
                                            <p class="text-gray-600">${translations[currentLang].currencySymbol}${item.product?.price || 0}</p>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="updateCartQuantity(${item.id}, ${item.quantity - 1})" 
                                                    ${item.quantity <= 1 ? 'disabled' : ''} 
                                                    class="w-8 h-8 rounded-full border border-gray-300 flex items-center justify-center text-sm">
                                                -
                                            </button>
                                            <span class="w-8 text-center">${item.quantity}</span>
                                            <button onclick="updateCartQuantity(${item.id}, ${item.quantity + 1})" 
                                                    class="w-8 h-8 rounded-full border border-gray-300 flex items-center justify-center text-sm">
                                                +
                                            </button>
                                        </div>
                                        <button onclick="removeFromCart(${item.id})" 
                                                class="text-red-600 hover:text-red-800 px-2 py-1 text-sm">
                                            ${translations[currentLang].removeFromCart}
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="mt-6 pt-4 border-t border-gray-200">
                                <div class="flex justify-between items-center mb-4">
                                    <span class="text-lg font-semibold">${translations[currentLang].total}:</span>
                                    <span class="text-2xl font-bold text-primary">${translations[currentLang].currencySymbol}${cart.items.reduce((sum, item) => sum + (item.product?.price || 0) * item.quantity, 0).toFixed(2)}</span>
                                </div>
                                <button class="w-full btn-primary py-3 rounded-lg text-lg font-semibold">
                                    ${translations[currentLang].checkout}
                                </button>
                            </div>
                        `}
                    </div>
                </div>
            `;
            cartModal.innerHTML = cartContent;
        }

        // 表单验证函数
        function validateEmail(email) {
            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            const emailError = document.getElementById('email-error');
            
            if (!email) return true;
            
            if (!emailRegex.test(email)) {
                emailError.textContent = translations[currentLang].invalidEmail;
                emailError.classList.remove('hidden');
                return false;
            } else {
                emailError.classList.add('hidden');
                return true;
            }
        }
        
        function validatePassword(password) {
            const passwordError = document.getElementById('password-error');
            
            if (!password) return true;
            
            if (password.length < 8) {
                passwordError.textContent = translations[currentLang].passwordTooShort;
                passwordError.classList.remove('hidden');
                return false;
            } else {
                passwordError.classList.add('hidden');
                return true;
            }
        }
        
        function validatePasswordConfirm(password, confirmPassword) {
            const confirmPasswordError = document.getElementById('confirm-password-error');
            
            if (!confirmPassword) return true;
            
            if (password !== confirmPassword) {
                confirmPasswordError.textContent = translations[currentLang].passwordMismatch;
                confirmPasswordError.classList.remove('hidden');
                return false;
            } else {
                confirmPasswordError.classList.add('hidden');
                return true;
            }
        }
        
        function validateRegisterForm(email, password, confirmPassword) {
            let isValid = true;
            if (!validateEmail(email)) isValid = false;
            if (!validatePassword(password)) isValid = false;
            if (!validatePasswordConfirm(password, confirmPassword)) isValid = false;
            return isValid;
        }
        
        function clearRegisterErrors() {
            ['email-error', 'password-error', 'confirm-password-error', 'register-error'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.add('hidden');
                    element.textContent = '';
                }
            });
        }

        // 媒体渲染
        function renderProductMedia(media, containerId) {
            const container = document.getElementById(containerId);
            if (!media || media.length === 0) {
                container.innerHTML = '<img src="/placeholder.jpg" alt="Product Image" class="w-full h-full object-cover rounded-lg">';
                return;
            }

            const images = media.filter(m => m.asset.mediaType === 'image');
            const videos = media.filter(m => m.asset.mediaType === 'video');

            let mediaHtml = '';

            if (images.length > 0) {
                mediaHtml += `
                    <div class="carousel relative w-full overflow-hidden rounded-lg shadow-lg mb-4">
                        <div class="carousel-inner flex transition-transform duration-500 ease-in-out">
                            ${images.map(imgLink => `
                                <div class="carousel-item min-w-full">
                                    <img src="${imgLink.asset.url}" alt="Product Image" class="w-full h-auto object-contain" style="max-height: 500px;">
                                </div>
                            `).join('')}
                        </div>
                        ${images.length > 1 ? `
                            <button class="carousel-control prev absolute top-1/2 left-2 -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full z-10">‹</button>
                            <button class="carousel-control next absolute top-1/2 right-2 -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full z-10">›</button>
                        ` : ''}
                    </div>
                `;
            }

            if (videos.length > 0) {
                // 为视频创建与图片相同的容器结构，确保对齐一致
                const videoGridClass = videos.length === 1 ? 'grid-cols-1' : 'grid-cols-1 md:grid-cols-2';
                mediaHtml += `<div class="${videos.length > 0 && images.length > 0 ? 'mt-4' : ''} grid ${videoGridClass} gap-4">`;
                videos.forEach((vidLink, index) => {
                    mediaHtml += `
                        <div class="video-container rounded-lg overflow-hidden shadow-lg">
                            <div class="relative">
                                <video 
                                    controls 
                                    preload="metadata"
                                    class="w-full h-auto" 
                                    style="max-height: 500px; min-height: 280px; background-color: #000;"
                                    onloadedmetadata="adjustVideoDisplay(this)"
                                    onerror="handleVideoError(this)"
                                    onloadstart="console.log('Video loading started:', this.src)"
                                    oncanplay="console.log('Video can play:', this.src)"
                                >
                                    <source src="${vidLink.asset.url}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                                <!-- 视频显示模式切换按钮 -->
                                <div class="absolute top-2 right-2 bg-black bg-opacity-50 rounded-md p-1 video-controls">
                                    <button 
                                        onclick="toggleVideoMode(this)" 
                                        class="text-white text-xs px-2 py-1 hover:bg-white hover:bg-opacity-20 rounded transition-colors"
                                        title="切换显示模式"
                                    >
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
                                        </svg>
                                    </button>
                                </div>
                                <!-- 视频加载状态指示 -->
                                <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-30 video-loading" style="display: none;">
                                    <div class="text-white text-center">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-2"></div>
                                        <p class="text-sm">加载中...</p>
                                    </div>
                                </div>
                                <!-- 视频错误指示 -->
                                <div class="absolute inset-0 flex items-center justify-center bg-red-900 bg-opacity-80 video-error" style="display: none;">
                                    <div class="text-white text-center p-4">
                                        <svg class="w-8 h-8 mx-auto mb-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                        </svg>
                                        <p class="text-sm">视频加载失败</p>
                                        <button onclick="retryVideo(this)" class="mt-2 px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-xs transition-colors">
                                            重试
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                mediaHtml += '</div>';
            }

            // 使用一致的容器约束，确保图片和视频都在相同的对齐框架内
            container.innerHTML = `<div class="max-w-[600px] mx-auto">${mediaHtml}</div>`;
            if (images.length > 1) {
                initCarousel(container.querySelector('.carousel'));
            }
        }

        function renderProductCard(product) {
            const thumbnailUrl = (product.media && product.media.length > 0) 
                ? product.media[0].asset.url 
                : '/placeholder.jpg';

            return `
                <div class="product-card rounded-lg p-4 shadow-lg hover:shadow-xl transition-all duration-300 flex flex-col justify-between">
                    <div class="mb-4">
                        <img src="${thumbnailUrl}" alt="${product.name || 'Product Image'}" class="w-full h-64 object-cover rounded-md mb-4">
                        <h3 class="text-xl font-bold mb-2 truncate">${product.name || 'Unnamed Product'}</h3>
                        <p class="text-gray-600 mb-4 text-sm h-20 overflow-hidden">${product.description || 'No description available'}</p>
                    </div>
                    <div class="flex justify-between items-center mt-auto">
                        <span class="text-2xl font-bold text-primary">${translations[currentLang].currencySymbol}${product.price}</span>
                        <div class="flex space-x-2">
                            <button onclick="addToCart(${product.id})" class="btn-primary px-3 py-2 rounded-md text-sm whitespace-nowrap">
                                ${translations[currentLang].addToCart}
                            </button>
                            <button onclick="showProductDetail(${product.id})" class="border border-gray-300 px-3 py-2 rounded-md text-sm hover:bg-gray-50 whitespace-nowrap">
                                ${translations[currentLang].viewDetails}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // 轮播功能
        function initCarousel(carousel) {
            if (!carousel) return;

            const inner = carousel.querySelector('.carousel-inner');
            const items = carousel.querySelectorAll('.carousel-item');
            const prevBtn = carousel.querySelector('.carousel-control.prev');
            const nextBtn = carousel.querySelector('.carousel-control.next');
            
            if (items.length <= 1) {
                if (prevBtn) prevBtn.style.display = 'none';
                if (nextBtn) nextBtn.style.display = 'none';
                return;
            }

            let currentIndex = 0;
            let intervalId = null;

            function updateCarousel() {
                const translateX = -currentIndex * 100;
                inner.style.transform = `translateX(${translateX}%)`;
            }

            function nextSlide() {
                currentIndex = (currentIndex + 1) % items.length;
                updateCarousel();
            }

            function prevSlide() {
                currentIndex = (currentIndex - 1 + items.length) % items.length;
                updateCarousel();
            }

            function startAutoplay() {
                stopAutoplay();
                intervalId = setInterval(nextSlide, 5000);
            }

            function stopAutoplay() {
                clearInterval(intervalId);
            }

            if (prevBtn) prevBtn.addEventListener('click', () => { prevSlide(); stopAutoplay(); });
            if (nextBtn) nextBtn.addEventListener('click', () => { nextSlide(); stopAutoplay(); });

            startAutoplay();
        }

        // 视频显示优化函数
        function adjustVideoDisplay(video) {
            if (!video.videoWidth || !video.videoHeight) {
                console.log('Video dimensions not available yet');
                return;
            }
            
            console.log(`Video dimensions: ${video.videoWidth}x${video.videoHeight}`);
            console.log('Video loaded successfully');
            
            // 隐藏加载指示器
            const loadingIndicator = video.parentElement.querySelector('.video-loading');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            
            // 强制重绘视频元素以解决渲染问题
            video.style.visibility = 'hidden';
            video.offsetHeight; // 触发重排
            video.style.visibility = 'visible';
            
            // 确保视频在正确的层级
            video.style.position = 'relative';
            video.style.zIndex = '1';
            
            console.log('Video display adjusted - using default sizing');
        }

        // 处理视频错误
        function handleVideoError(video) {
            console.error('Video error:', video.error);
            const container = video.closest('.video-container');
            const errorIndicator = container.querySelector('.video-error');
            const loadingIndicator = container.querySelector('.video-loading');
            
            // 隐藏加载指示器，显示错误指示器
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            if (errorIndicator) errorIndicator.style.display = 'flex';
            
            // 尝试检测视频格式并提供建议
            const videoUrl = video.src || (video.querySelector('source') && video.querySelector('source').src);
            console.log('Failed video URL:', videoUrl);
            
            // 检查是否是CORS问题
            if (video.error && video.error.code === MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED) {
                console.warn('Video format not supported or CORS issue');
            }
        }

        // 重试加载视频
        function retryVideo(button) {
            const container = button.closest('.video-container');
            const video = container.querySelector('video');
            const errorIndicator = container.querySelector('.video-error');
            const loadingIndicator = container.querySelector('.video-loading');
            
            // 显示加载指示器，隐藏错误指示器
            if (errorIndicator) errorIndicator.style.display = 'none';
            if (loadingIndicator) loadingIndicator.style.display = 'flex';
            
            console.log('Retrying video load...');
            
            // 重新加载视频
            video.load();
            
            // 添加超时处理
            setTimeout(() => {
                if (video.readyState < 2) { // HAVE_CURRENT_DATA
                    console.warn('Video still not loading after retry');
                    handleVideoError(video);
                }
            }, 10000); // 10秒超时
        }

        // 切换视频显示模式
        function toggleVideoMode(button) {
            const video = button.closest('.video-container').querySelector('video');
            const currentMode = video.style.objectFit || 'fill'; // 默认使用 fill
            
            if (currentMode === 'fill' || currentMode === '') {
                // 切换到 contain 模式（完整显示，可能有黑边）
                video.style.objectFit = 'contain';
                video.style.backgroundColor = '#000';
                button.title = '切换到填充模式';
                console.log('Switched to contain mode');
            } else {
                // 切换回默认模式
                video.style.objectFit = 'fill';
                video.style.backgroundColor = 'transparent';
                button.title = '切换到适应模式';
                console.log('Switched to fill mode');
            }
        }

        // 检查视频兼容性
        function checkVideoSupport() {
            const video = document.createElement('video');
            const formats = {
                mp4: video.canPlayType('video/mp4'),
                webm: video.canPlayType('video/webm'),
                ogg: video.canPlayType('video/ogg')
            };
            console.log('Supported video formats:', formats);
            return formats;
        }

        async function showProductDetail(productId) {
            currentProductId = productId;
            try {
                showMessage('Loading product details...');
                const product = await apiFetch(`/api/products/${productId}?lang=${currentLang}`);
                const productPage = document.getElementById('product-page');

                productPage.innerHTML = `
                    <section class="py-12 px-4">
                        <div class="container mx-auto">
                            <button onclick="showPage('shop')" class="mb-8 text-gold hover:text-primary">&larr; Back to All Artifacts</button>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-start">
                                <div id="product-media-container"></div>
                                <div>
                                    <h1 class="text-4xl font-serif-sc font-bold mb-4 text-gold">${product.name}</h1>
                                    <p class="text-gray-400 mb-6 leading-relaxed">${product.description}</p>
                                    <div class="text-4xl font-bold text-primary mb-8">${translations[currentLang].currencySymbol}${product.price}</div>
                                    <button onclick="addToCart(${product.id})" class="btn-primary w-full py-4 text-lg rounded-lg font-semibold transform hover:scale-105 transition-transform">
                                        ${translations[currentLang].addToCart}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </section>
                `;

                renderProductMedia(product.media, 'product-media-container');
                showPage('product');
                window.scrollTo(0, 0);
                showMessage('Product loaded.', false);
            } catch (error) {
                console.error('Failed to show product detail:', error);
                showMessage('Could not load product details.', true);
            }
        }

        // 页面管理
        function showPage(pageId) {
            if (pageId !== 'product') {
                currentProductId = null;
            }
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            document.getElementById(`${pageId}-page`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[onclick="showPage('${pageId}')"]`)?.classList.add('active');
        }

        async function loadProducts() {
            try {
                const products = await apiFetch(`/api/products?lang=${currentLang}`);
                allProducts = products;
                renderHomePage();
                renderShopPage();
            } catch (error) {
                console.error('Failed to load products:', error);
                showMessage('Failed to load products', 'error');
            }
        }

        function renderHomePage() {
            const featuredProducts = allProducts.filter(p => p.featured).slice(0, 6);
            
            document.getElementById('home-page').innerHTML = `
                <section class="relative h-screen flex items-center justify-center text-center bg-gradient-to-b from-black via-gray-900 to-black">
                    <div class="absolute inset-0 bg-black opacity-60"></div>
                    <div class="relative z-10 max-w-4xl mx-auto px-6">
                        <h1 class="text-6xl md:text-8xl font-serif-sc font-bold mb-6 text-gold tracking-wider">
                            ${translations[currentLang].siteName}
                        </h1>
                        <p class="text-xl md:text-2xl text-gray-300 mb-8 leading-relaxed">
                            Discover ancient artifacts imbued with mystical powers
                        </p>
                        <button onclick="showPage('shop')" class="btn-primary px-8 py-4 text-lg rounded-lg font-semibold transform hover:scale-105 transition-all duration-300">
                            Explore Artifacts
                        </button>
                    </div>
                </section>

                <section class="py-20 px-6">
                    <div class="container mx-auto">
                        <h2 class="text-4xl font-serif-sc font-bold text-center mb-12 text-gold">Featured Artifacts</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            ${featuredProducts.map(product => renderProductCard(product)).join('')}
                        </div>
                    </div>
                </section>
            `;
            
            setTimeout(() => {
                document.querySelectorAll('.carousel').forEach(initCarousel);
            }, 100);
        }

        function renderShopPage() {
            document.getElementById('shop-page').innerHTML = `
                <section class="py-20 px-6">
                    <div class="container mx-auto">
                        <h1 class="text-4xl font-serif-sc font-bold text-center mb-12 text-gold">${translations[currentLang].navShop}</h1>
                        
                        <div class="mb-8 flex flex-wrap gap-4 justify-center items-center">
                            <input type="text" id="search-input" placeholder="${translations[currentLang].search}" 
                                   class="px-4 py-2 rounded-lg border border-gray-300 bg-white text-black" style="min-width: 250px;">
                            <select id="category-filter" class="px-4 py-2 rounded-lg border border-gray-300 bg-white text-black">
                                <option value="">${translations[currentLang].allCategories}</option>
                            </select>
                        </div>
                        
                        <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                            ${allProducts.map(product => renderProductCard(product)).join('')}
                        </div>
                    </div>
                </section>
            `;
            
            populateCategoryFilter();
            setTimeout(() => {
                document.querySelectorAll('.carousel').forEach(initCarousel);
            }, 100);
        }

        async function populateCategoryFilter() {
            try {
                const categories = await apiFetch('/api/products/categories');
                const categoryFilter = document.getElementById('category-filter');
                if (categoryFilter) {
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categoryFilter.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to fetch categories:', error);
            }
        }

        // 初始化应用
        async function initApp() {
            // 检查视频格式支持
            checkVideoSupport();
            
            // 设置事件监听器
            loginButton.addEventListener('click', () => {
                openModal(loginModal);
                renderLoginModal();
            });
            
            cartButton.addEventListener('click', () => {
                renderCartModal();
                openModal(cartModal);
            });
            
            logoutButton.addEventListener('click', logout);
            
            langZh.addEventListener('click', () => {
                currentLang = 'zh';
                updateLanguage();
                loadProducts();
                if (currentProductId && !document.getElementById('product-page').classList.contains('hidden')) {
                    showProductDetail(currentProductId);
                }
            });
            
            langEn.addEventListener('click', () => {
                currentLang = 'en';
                updateLanguage();
                loadProducts();
                if (currentProductId && !document.getElementById('product-page').classList.contains('hidden')) {
                    showProductDetail(currentProductId);
                }
            });

            // 初始化语言和用户状态
            updateLanguage();
            await checkUserStatus();
            await loadProducts();
            
            // 显示首页
            showPage('home');
        }

        // 启动应用
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
    </script>
</body>
</html>